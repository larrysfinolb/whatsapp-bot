name: Build & Deploy WhatsApp Bot

on:
  release:
    types: [published]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: magenta/whatsapp-bot

jobs:
  # ------------------------------------------------------------------------------
  # JOB 1: BUILD AND PUSH IMAGE
  # ------------------------------------------------------------------------------
  build-and-push:
    name: üê≥ Build & Push Docker Image
    runs-on: ubuntu-latest
    # Export registry URL for the next job
    outputs:
      registry: ${{ steps.login-ecr.outputs.registry }}

    steps:
      # 1. Checkout source code
      - name: üì• Checkout Code
        uses: actions/checkout@v6

      # 2. Configure AWS Credentials
      - name: üîë Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          aws-region: ${{ env.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # 3. Login to ECR
      - name: üîì Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4. Build the image
      - name: üèóÔ∏è Build Docker Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.event.release.tag_name }}
        run: |
          echo "üèóÔ∏è Building image with tag: $IMAGE_TAG..."
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .

      # 5. Push the image
      - name: ‚¨ÜÔ∏è Push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.event.release.tag_name }}
        run: |
          echo "üöÄ Pushing specific tag: $IMAGE_TAG..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

          echo "üöÄ Pushing 'latest' tag..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "‚úÖ Build and Push completed successfully!"

  # ------------------------------------------------------------------------------
  # JOB 2: DEPLOY TO EC2 SERVER (SELF-HOSTED)
  # ------------------------------------------------------------------------------
  deploy-to-ec2:
    name: üöÄ Deploy on Server
    needs: build-and-push
    runs-on: self-hosted

    steps:
      # 1. Configure AWS Credentials
      - name: üîë Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          aws-region: ${{ env.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # 2. Login to ECR
      - name: üîì Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 3. Pull & Run (Agregu√© el nombre que faltaba)
      - name: ‚¨áÔ∏è Pull & Restart Container
        env:
          ECR_REGISTRY: ${{ needs.build-and-push.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        run: |
          echo "‚¨áÔ∏è Pulling latest image..."
          docker pull $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "üõë Stopping old container..."
          docker stop whatsapp-bot || true
          docker rm whatsapp-bot || true

          echo "üöÄ Starting new container..."
          docker run -d \
            --name whatsapp-bot \
            --restart always \
            -p 3000:3000 \
            $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "üßπ Cleaning up..."
          docker image prune -f

          echo "‚úÖ Deployment completed successfully!"
